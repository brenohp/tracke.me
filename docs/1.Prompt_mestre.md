Olá! Vamos continuar o desenvolvimento do projeto **CliendaApp**.

Esta mensagem serve como a base de conhecimento e o guia de padrões para este projeto. Por favor, absorva estas informações e siga-as rigorosamente em todo o desenvolvimento.

### 1. Visão Geral do Projeto

* **Nome:** CliendaApp
* **Missão:** Um SaaS para pequenos negócios (salões de beleza, barbearias, etc.) que simplifica a gestão de clientes e agenda, com um diferencial de automação de agendamentos via IA no WhatsApp.
* **Foco:** Facilidade de uso extrema para usuários com pouca familiaridade tecnológica.

### 2. Stack de Tecnologias

* **Framework:** Next.js (App Router)
* **Linguagem:** TypeScript
* **Estilização:** Tailwind CSS
* **Banco de Dados:** PostgreSQL
* **ORM:** Prisma
* **WEBSOCKETS:** Pusher

### 3. Padrões de Arquitetura e Código (Indispensáveis)

#### 3.1. Arquitetura de Componentes (Next.js App Router)

* **Server Components (`page.tsx`, `layout.tsx`):** São o padrão. **Nunca** devem ter a diretiva `"use client";"`. As suas responsabilidades são:
    1.  Buscar dados diretamente do banco de dados (`prisma`).
    2.  Verificar a autenticação e as permissões.
    3.  Passar os dados para os Componentes de Cliente como `props`.
* **Client Components (`"use client";`):** Usados apenas para interatividade.
    1.  Qualquer componente que use hooks como `useState`, `useEffect`, ou eventos como `onClick` deve ser um Componente de Cliente, isolado no seu próprio ficheiro.
    2.  O `layout.tsx` do dashboard usa o padrão "Shell": o layout em si é de servidor, mas ele renderiza um componente de cliente que contém toda a parte interativa/dashboard/_components/DashboardShell.tsx, docs/1.Prompt_mestre.md].

#### 3.2. Fluxo de Dados (Server -> Client)

* **Serialização é Obrigatória:** Ao passar dados de um Componente de Servidor para um de Cliente, tipos complexos como `Decimal`, `Date` e `Json` devem ser convertidos para tipos simples.
    * `Decimal` -> `.toString()`
    * `Date` -> `.toISOString()`
    * `Json` -> `JSON.stringify()`

#### 3.3. Autenticação e APIs

* **Método de Autenticação:** A autenticação é feita exclusivamente via **cookies `httpOnly`**. As APIs **não** usam `Bearer token` no cabeçalho.
* **Leitura de Cookies na API:** As rotas de API devem usar `await cookies()` de `next/headers` para ler o token.
* **Segurança de Rotas:**
    * Rotas do dashboard do cliente (`/api/...`) são protegidas e validam a sessão do usuário.
    * Rotas do painel de admin (`/api/admin/...`) são protegidas e devem verificar especificamente se `session.role === 'ADMIN'`.

#### 3.4. Padrões de UI/UX

* **Paleta de Cores (Padrão "Maré Noturna"):** Uso obrigatório das cores de marca configuradas no `tailwind.config.ts`.
* **Notificações:** Todas as mensagens de feedback para o usuário (sucesso, erro, etc.) devem ser feitas usando a biblioteca **`react-hot-toast`**.
* **CRUD em Modais:** Todas as operações de Criar e Editar são feitas dentro de componentes de Modal para manter a interface limpa.

#### 3.5. Padrões de API e Gestão de Erros

* **Respostas de Erro Claras:** Todas as rotas de API devem retornar mensagens de erro significativas em formato JSON. Ex: `{ "message": "Este e-mail já está em uso." }`.
* **Códigos de Status HTTP:** Utilizar os códigos de status HTTP corretamente (ex: `200` OK, `201` Created, `400` Bad Request, `401` Unauthorized, `403` Forbidden, `404` Not Found, `409` Conflict, `500` Internal Server Error).
* **Logs no Servidor:** Todos os erros inesperados (status 500) devem ser logados com `console.error` para facilitar a depuração.

#### 3.6. Padrões de Código Adicionais (Observados no Projeto)

* **Extração de Parâmetros em API Routes:** Para rotas dinâmicas (ex: `[id]`), os parâmetros são extraídos manualmente do `request.url` em vez de usar o segundo argumento `params`. Seguir este padrão: `const url = new URL(request.url); const id = url.pathname.split('/').pop();`/route.ts, src/app/api/services/[id]/route.ts].
* **Revalidação de Cache:** Após qualquer operação de `create`, `update` ou `delete` numa API Route que afete dados exibidos em Server Components, utilizar `revalidatePath()` de `next/cache` para garantir que os dados sejam atualizados/route.ts].
* **Consultas com Prisma:** Utilizar `select` e `include` para otimizar as consultas, buscando apenas os dados necessários para cada contexto.
* **Componentização:** Manter a estrutura de ficheiros onde a página (`page.tsx`) é um Server Component e a view interativa (`...View.tsx` ou `...ClientView.tsx`) é um Client Component que recebe os dados via props.

### 4. Ambiente e Domínios

* **Desenvolvimento:** O ambiente de desenvolvimento local deve rodar em **`lvh.me:3000`** para permitir o uso de subdomínios e o correto funcionamento dos cookies.
* **Produção:** O domínio de produção é **`clienda.app`**, e os subdomínios dos clientes seguirão o formato `subdominio.clienda.app`.

### 5. Estado Atual e Próximo Passo

* **Progresso:** Os módulos de Fundação, Marketing, Dashboard Core, Admin, Faturamento e Comunicação Essencial estão **concluídos**. O produto está tecnicamente pronto para aceitar e gerir clientes.
* **Foco Atual:** Nossa prioridade máxima é o **Módulo 7: Onboarding do Novo Usuário**. O objetivo é desenhar e implementar um fluxo de boas-vindas que guie os novos clientes pagantes pelas configurações essenciais, garantindo que eles ativem a conta e percebam o valor do produto rapidamente para maximizar a retenção.

---

Por favor, confirme que você entendeu todas estas regras. Na minha próxima mensagem, enviarei o `schema.prisma` completo para que você tenha a estrutura de dados final.


Observações: Trate de usar a sintaxe e padrões de códigos mais atuais de acordo com os frameworks e ferramentas que estamos utilizando, para evitar erros e frustrações futuras.